/**
 * ----------------------------------------
 * ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆç®€æ˜“ç‰ˆï¼‰
 * ----------------------------------------
 *
 * ç”¨äºå°†å‰¯ä½œç”¨ä»»åŠ¡ï¼ˆå¦‚ç»„ä»¶æ›´æ–°ï¼‰è¿›è¡Œï¼š
 *   - å»é‡
 *   - å¼‚æ­¥è°ƒåº¦ï¼ˆå¾®ä»»åŠ¡ï¼‰
 *   - æ‰¹é‡æ‰§è¡Œ
 *
 * ğŸ‘‰ æ˜¯ Vue3 â€œå“åº”å¼ â†’ æ¸²æŸ“æ›´æ–°â€ çš„å…³é”®æ¡¥æ¢
 *
 */

// ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œç”¨ä¸€ä¸ª Set æ•°æ®ç»“æ„æ¥è¡¨ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨å¯¹ä»»åŠ¡è¿›è¡Œå»é‡
const queue = new Set()
// ä¸€ä¸ªæ ‡å¿—ï¼Œä»£è¡¨æ˜¯å¦æ­£åœ¨åˆ·æ–°ä»»åŠ¡é˜Ÿåˆ—
let isFlushing = false
// åˆ›å»ºä¸€ä¸ªç«‹å³ resolve çš„ Promise å®ä¾‹
const p = Promise.resolve()

/**
 * è°ƒåº¦å™¨çš„ä¸»è¦å‡½æ•°ï¼Œç”¨æ¥å°†ä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°ç¼“å†²é˜Ÿåˆ—ä¸­ï¼Œå¹¶å¼€å§‹åˆ·æ–°é˜Ÿåˆ—
 *
 * @param {Function} job - è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆé€šå¸¸æ˜¯ç»„ä»¶æ›´æ–°å‡½æ•° effectï¼‰
 *
 * @returns {void}
 */
function queueJob(job) {
  // å°† job æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ— queue ä¸­
  queue.add(job)
  // å¦‚æœè¿˜æ²¡æœ‰æ³¨å†Œåˆ·æ–°ä»»åŠ¡ï¼Œé‚£ä¹ˆæ³¨å†Œä¸€ä¸ª
  if(!isFlushing) {
    // å°†è¯¥æ ‡å¿—è®¾ç½®ä¸º true ä»¥é¿å…é‡å¤åˆ·æ–°
    isFlushing = true
    // åœ¨å¾®ä»»åŠ¡ä¸­åˆ·æ–°ç¼“å†²é˜Ÿåˆ—
    p.then(() => {
      try {
        // æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
        queue.forEach(job => job())
      } finally {
        // é‡ç½®çŠ¶æ€
        isFlushing = false
        queue.clear()
      }
    })
  }
}